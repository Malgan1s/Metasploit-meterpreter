# Исследование уязвимости семейства MS17-010


# 1 Введение

В данной лабораторной работе рассмотрены подходы к повышению
защищённости организационной инфраструктуры через практическое
исследование уязвимости семейства MS17-010 и анализа сетевого
взаимодействия на примере виртуальной сети, развернутой в VirtualBox.
Работа включает настройку двух виртуальных машин --- атакующей на Kali
Linux и целевой на Windows XP --- проверку сетевой доступности, сбор
трафика с помощью Wireshark и практическую эксплуатацию уязвимости с
применением Metasploit, что позволяет проследить все ключевые этапы
атаки от установления TCP-сессии до получения удалённого доступа через
meterpreter. Такой прикладной подход даёт возможность увидеть не только
теоретические схемы эксплуатации, но и конкретные сетевые артефакты,
которые остаются в трафике и служат основой для детектирования
инцидентов.

# 2 Основная часть

Для начала устанавливаем в программе VirtualBox две операционные системы
-- Windows XP ("жертва") и Kali Linux ("атакующий"), -- и задаём сетевые
параметры, так, чтобы данные ОС имели сетевую доступность.

Для ОС Windows XP:

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Мультимедийное программное обеспечение Содержимое,
созданное искусственным интеллектом, может быть
неверным.](media/image1.png)

Рисунок 1 -- Настройка сети для ОС Windows XP в VirtualBox

Для ОС Kali Linux:

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Мультимедийное программное обеспечение Содержимое,
созданное искусственным интеллектом, может быть
неверным.](media/image2.png){width="6.23831583552056in"
height="3.4882556867891514in"}

Рисунок 2 -- Настройка сети для ОС Kali Linux в VirtualBox

Теперь проверим сеть в каждой системе и зафиксируем ip адреса:

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Шрифт Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image3.png){width="6.496527777777778in"
height="7.083333333333333in"}

Рисунок 3 -- Сеть на каждой ОС

В итоге получили следующие ip адреса:

ОС Windows: 192.168.1.25

ОС Linux: 192.168.1.15

Проверяем, что обе машины "видят" друг друга:

![Изображение выглядит как текст, снимок экрана, Шрифт Содержимое,
созданное искусственным интеллектом, может быть
неверным.](media/image4.png){width="6.496527777777778in"
height="1.086111111111111in"}

Рисунок 3 -- Перекрёстный ping

Далее для удобства сменим имя ОС Windows XP:

![Изображение выглядит как текст, электроника, снимок экрана,
программное обеспечение Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image5.png){width="3.1859864391951005in"
height="3.9291371391076115in"}

Рисунок 4 -- Изменение имени хоста

Запускаем Wireshark и подготавливаем возможность записи трафика перед
включением ОС Windows XP SP3, настраиваем фильтры ip.addr == \<адрес
атакующего\> \|\| ip.addr == \<адрес жертвы\>:

ip.addr == 192.168.1.15 \|\| ip.addr == 192.168.1.25

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Мультимедийное программное обеспечение Содержимое,
созданное искусственным интеллектом, может быть
неверным.](media/image6.png){width="6.496527777777778in"
height="5.4847222222222225in"}

Рисунок 5 -- Подготовка возможности записи трафика

Далее необходимо выполнить следующие команды:

- sudo apt-get update

- sudo apt-get updrage

- sudo msfconsole

> \> use exploit/windows/smb/ms17_010_psexec

Результат выполнения команд представлен на рисунке 6. Судя по рисунку,
можно сделать вывод, что для семейства эксплойтов MS17-010 в качестве
вредоносной "полезной нагрузки" по умолчанию задан meterpreter.

![Изображение выглядит как текст, снимок экрана, Шрифт, дизайн
Содержимое, созданное искусственным интеллектом, может быть
неверным.](media/image7.png){width="6.229166666666667in"
height="3.8958333333333335in"}

Рисунок 6 -- Запуск msfconsole

Далее выполняем:

\> show options

\> set rhosts 192.168.1.25

\> exploit

Получаем следующий результат выполнения команд:

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Шрифт Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image8.png){width="6.496527777777778in"
height="6.195833333333334in"}

Рисунок 7 -- Эксплуатация уязвимости

Сохраняем весь записанный трафик и теперь подробно его изучим.
Проанализируем с помощью Wireshark стадии инициализации SMBv1: начиная с
построения TCP-сессии (Рисунок 8), включая Negotiate-запрос на
аутентификацию по NTLM (Рисунок 9) и ответный Challenge (Рисунок 10).

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, дисплей Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image9.png){width="6.496527777777778in"
height="3.2423611111111112in"}

Рисунок 8 -- Создание TCP-соединения SMB

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, дисплей Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image10.png){width="6.496527777777778in"
height="3.232638888888889in"}

Рисунок 9 -- Negotiate-запрос на аутентификацию

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, дисплей Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image11.png){width="6.496527777777778in"
height="3.2305555555555556in"}

Рисунок 10 -- Ответный пакет с Challenge

Далее происходит аутентификация анонимного пользователя:

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Мультимедийное программное обеспечение Содержимое,
созданное искусственным интеллектом, может быть
неверным.](media/image12.png){width="6.496527777777778in"
height="2.9194444444444443in"}

Рисунок 11 -- Запрос на анонимную аутентификацию

Далее выполняем следующее действие: с помощью выбора начального пакета
SMB нажимаем правой кнопкой мыши "Следовать" $- >$ "Поток TCP", затем
выбираем в поле "Показать данные как" значение "Шестнадцатеричный Дамп".

Обращаем внимание на аномально "большой" пакет, длина которого -- ровно
512 байт:

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, дисплей Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image13.png){width="6.496527777777778in"
height="2.9902777777777776in"}

Рисунок 12 -- Аномально "большой" пакет

Это одно из необходимых условий, чтобы проэксплуатировать одну из ошибок
и задействовать "вторичные запросы" Trans Secondary Request -- в логике
обработки таких запросов и существует уязвимость:

![Изображение выглядит как текст, Шрифт, число, программное обеспечение
Содержимое, созданное искусственным интеллектом, может быть
неверным.](media/image14.png){width="6.496527777777778in"
height="1.6854166666666666in"}

Рисунок 13 -- Создание запросов Trans Secondary Request

Далее происходит сама эксплуатация уязвимости: перезапись данных в
памяти уязвимой ОС Windows XP, что приводит к перехвату управления.
Например, имеется возможность обратиться к специальному каталогу
ADMIN\$, в нормальных условиях эксплуатации для доступа к нему нужны
учетные данные. Доступ к этому каталогу позволяет получить контроль над
ОС Windows. После эксплуатации уязвимости доступ к каталогу ADMIN\$
имеется без каких-либо учетных данных (Рисунок 14, Рисунок 15).

![Изображение выглядит как текст, Шрифт, программное обеспечение, число
Содержимое, созданное искусственным интеллектом, может быть
неверным.](media/image15.png){width="6.496527777777778in"
height="1.9902777777777778in"}

Рисунок 14 -- Запрос к ADMIN\$

![Изображение выглядит как текст, Шрифт, линия, программное обеспечение
Содержимое, созданное искусственным интеллектом, может быть
неверным.](media/image16.png){width="6.496527777777778in"
height="1.8583333333333334in"}

Рисунок 15 -- Успешный ответ на запрос к ADMIN\$

После получения доступа к ADMIN\$ производится запись исполняемого
PE-файла -- "полезной нагрузки" meterpreter (Рисунок 14, Рисунок 15).

![Изображение выглядит как текст, программное обеспечение,
Мультимедийное программное обеспечение, Значок на компьютере Содержимое,
созданное искусственным интеллектом, может быть
неверным.](media/image17.png){width="6.496527777777778in"
height="2.2680555555555557in"}

Рисунок 14 -- Запрос на открытие файла "csdMgfFQ.exe"

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, компьютер Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image18.png){width="6.496527777777778in"
height="2.4458333333333333in"}

Рисунок 15 -- Передача PE-файла meterpreter

Далее происходит обращение к именованному каналу \\svcctl, который
отвечает за удаленное управление службами (Рисунок 16, Рисунок 17).

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, дисплей Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image19.png){width="6.496527777777778in"
height="3.0125in"}

Рисунок 16 -- Обращение к \\svcctl

![Изображение выглядит как текст, снимок экрана, дисплей, программное
обеспечение Содержимое, созданное искусственным интеллектом, может быть
неверным.](media/image20.png){width="6.496527777777778in"
height="2.779166666666667in"}

Рисунок 17 -- Запрос на создание службы

После успешного запуска службы производится ее удаление (Рисунок 18) и
удаление соответствующего файла (Рисунок 19).

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, дисплей Содержимое, созданное искусственным интеллектом,
может быть неверным.](media/image21.png){width="6.496527777777778in"
height="2.4159722222222224in"}

Рисунок 18 -- Запрос на удаление службы

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Значок на компьютере Содержимое, созданное искусственным
интеллектом, может быть
неверным.](media/image22.png){width="6.496527777777778in"
height="2.404166666666667in"}

Рисунок 19 -- Запрос на удаление файла

Почти в самом конце атаки создается соединение на исходящий TCP-порт
4444 на адрес атакующего (Рисунок 20) -- это сессия meterpreter.

![Изображение выглядит как текст, снимок экрана, программное
обеспечение, Значок на компьютере Содержимое, созданное искусственным
интеллектом, может быть
неверным.](media/image23.png){width="6.496527777777778in"
height="2.098611111111111in"}

Рисунок 20 -- Сетевое соединение meterpreter

Для того, чтобы злоумышленник удаленно выполнял команды на
скомпрометированной ОС, нужно, чтобы это соединение почти постоянно
производило коммуникацию. Однако в настоящее время появились более
совершенные инструменты пост-эксплуатации -- так называемые "Command and
Control frameworks", или просто C2-фреймворки. В последнее время
наиболее популярным у злоумышленников является sliver.

**2.2 Дополнительное задание**

**Часть 1** -- Концепция защиты от риска эксплуатации EternalBlue

Для снижения риска эксплуатации уязвимостей семейства EternalBlue
следует применить многослойную защиту: немедленно задеплоить официальные
патчи и обновления ОС (или перевести системы с неподдерживаемого Windows
XP на поддерживаемые платформы), полностью отключить поддержку SMBv1
через политики и конфигурационные изменения, сегментировать сеть и
ограничить доступ по TCP/445 правилами межсетевых экранов (разрешать SMB
только между строго определёнными серверами и администраторскими
хостами), внедрить мониторинг и IDS/EDR с эвристиками для SMB (детекция
аномально больших Trans2-пакетов, последовательностей Trans Secondary +
попытки доступа к административным шарам ADMIN\$ и вызовы \\svcctl) и
включить ограничение привилегий доступа к административным шарам.

**3 Выводы по выполненной работе**

В ходе выполнения лабораторной работы была показана классическая цепочка
успешной эксплуатации -- от обнаружения сетевой доступности и уязвимой
реализации SMBv1 до загрузки и исполнения полезной нагрузки, получения
доступа к административным ресурсам и установления устойчивой сессии
пост-эксплуатации. Анализ захваченного трафика продемонстрировал
характерные сигнатуры и этапы (установление TCP, NTLM
Negotiate/Challenge, аномально большие пакеты Trans Secondary Request),
которые могут и должны использоваться для детектирования подобных атак в
продуктивных сетях.

